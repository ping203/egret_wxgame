var __reflect=this&&this.__reflect||function(e,t,i){e.__class__=t,i?i.push(t):i=[t],e.__types__=e.__types__?i.concat(e.__types__):i},__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),AssetAdapter=function(){function e(){}return e.prototype.getAsset=function(e,t,i){function r(r){t.call(i,r,e)}if(RES.hasRes(e)){var n=RES.getRes(e);n?r(n):RES.getResAsync(e,r,this)}else RES.getResByUrl(e,r,this,RES.ResourceItem.TYPE_IMAGE)},e}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.x=0,this.textField.y=600,this.textField.width=640,this.textField.height=100,this.textField.textAlign=egret.HorizontalAlign.CENTER,this.con=new egret.DisplayObjectContainer,this.con.x=320,this.con.y=500;for(var e=(egret.MainContext.instance.stage,0),t=.1,i=0;10>i;i++){var r=new egret.Shape;r.graphics.beginFill(8156010,t),r.graphics.drawCircle(0,0,10),r.graphics.endFill(),r.anchorOffsetX=-60,r.anchorOffsetY=r.height>>1,r.rotation=e,this.con.addChild(r),e+=36,t+=.1}this.addChild(this.con),this.addEventListener(egret.Event.ENTER_FRAME,this.upLoadingData,this)},t.prototype.upLoadingData=function(){this.con.rotation+=36},t.prototype.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isThemeLoadEnd=!1,t.isResourceLoadEnd=!1,t}return __extends(t,e),t.prototype.createChildren=function(){e.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(e){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var t=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",t),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},t.prototype.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},t.prototype.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},t.prototype.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},t.prototype.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},t.prototype.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},t.prototype.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},t.prototype.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},t.prototype.startCreateScene=function(){this.addChild(new Game2048)},t}(eui.UILayer);__reflect(Main.prototype,"Main");var ThemeAdapter=function(){function e(){}return e.prototype.getTheme=function(e,t,i,r){function n(e){t.call(r,e)}function s(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),i.call(r))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),RES.getResByUrl(e,n,this,RES.ResourceItem.TYPE_TEXT)},e}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Game2048=function(e){function t(){var i=e.call(this)||this;return i.gridNum=16,i._size=125,i._radius=15,i._space=20,i._grade=0,i._best=0,i.items=[[],[],[],[]],i.running=0,i.record=0,i.bestRecord=0,i.skinName="Game2048Skin",t.self=i,i.addEventListener(egret.Event.ADDED_TO_STAGE,i.addFromStage,i),i.addEventListener(egret.Event.REMOVED_FROM_STAGE,i.removeFromStage,i),i}return __extends(t,e),t.prototype.addFromStage=function(){for(var e=0;e<this.gridNum;e++){var t=(Math.floor(e/4),this._space+(this._space+this._size)*(e%4)),i=this._space+(this._space+this._size)*Math.floor(e/4),r=Util.createRect(t,i,this._size,this._radius,13484468);this.contentCon.addChild(r)}this.contentCon.touchChildren=!1,this.gameOver.anchorOffsetX=this.gameOver.width>>1,this.gameOver.anchorOffsetY=this.gameOver.height>>1,this.gameOver.x=this.width>>1,this.gameOver.y=this.height>>1,this.gameOver.visible=!1,this.bestTxt.text="0",this.gradeTxt.text="0",this.contentCon.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onclick,this),this.newBtn.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onclick,this),this.newGame.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onclick,this),document.addEventListener("keydown",this.onKeyup),this.resetGrids()},t.prototype.onKeyup=function(e){switch(e.keyCode){case 37:t.self.doMove(3);break;case 38:t.self.doMove(0);break;case 39:t.self.doMove(1);break;case 40:t.self.doMove(2)}},t.prototype.onclick=function(e){switch(e.target){case this.newBtn:this.resetGrids();break;case this.newGame:this.resetGrids();break;case this.contentCon:if(e.type==egret.TouchEvent.TOUCH_BEGIN)this._startPoint=new egret.Point(e.stageX,e.stageY),this.contentCon.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onclick,this);else if(e.type==egret.TouchEvent.TOUCH_MOVE){this._endPoint=new egret.Point(e.stageX,e.stageY);var t=this._endPoint.x-this._startPoint.x,i=this._endPoint.y-this._startPoint.y;if(Math.abs(t-i)<=40)return;var r=Math.abs(t)>Math.abs(i)?t>0?1:3:i>0?2:0;this.doMove(r),this.contentCon.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onclick,this)}}},t.prototype.resetGrids=function(){for(var e=this,t=0;t<this.items.length;t++)for(var i=0;i<this.items[t].length;i++)this.items[t][i].item&&(this.items[t][i].item.setData(Util.numStyle[0]),this.items[t][i].value=0,this.removeFromParent(this.items[t][i].item));this._grade=0,this.scoreTxt.text=""+this._grade;for(var t=0;t<this.items.length;t++)for(var i=0;4>i;i++){this.items[t]||(this.items[t]=[]);var r=new GridItemData;r.value=0,r.i=0,r.j=0,this.items[t][i]=r}this.addNewGrids(2),this.gameOver.visible&&egret.Tween.get(this.gameOver).to({scaleX:0,scaleY:0},300).call(function(){e.gameOver.visible=!1},this)},t.prototype.usefulCell=function(){for(var e=[],t=0;4>t;t++)for(var i=0;4>i;i++)this.items[t][i]&&0==this.items[t][i].value&&(this.items[t][i].j=i,this.items[t][i].i=t,e.push(this.items[t][i]));return e},t.prototype.selectCell=function(){var e=this.usefulCell();return e.length?e[Math.floor(Math.random()*e.length)]:void 0},t.prototype.addNewGrids=function(e){if(!this.isOver())for(var t=0;e>t;t++){var i=this.selectCell();if(!i)return;var r=Math.random()<.9?2:4,n=new GridItem;n.setData(Util.numStyle[r]),n.x=i.disX,n.y=i.disY,this.contentCon.addChild(n),this.items[i.i][i.j].item=n,this.items[i.i][i.j].value=r}},t.prototype.formList=function(e){for(var t=[[],[],[],[]],i=0;4>i;i++)for(var r=0;4>r;r++)switch(e){case 0:t[i].push(this.items[r][i]);break;case 1:t[i].push(this.items[i][3-r]);break;case 2:t[i].push(this.items[3-r][i]);break;case 3:t[i].push(this.items[i][r])}return t},t.prototype.doMove=function(e){var t=this;if(!this.isOver())for(var i,r=this.formList(e),n=0;n<r.length;n++)for(var s,o=function(e){i=-1;for(var o=e+1;o<r[n].length;o++)if(0!=r[n][o].value){i=o;break}if(-1!==i){var h=r[n][e],c=r[n][i],l=60*Math.abs(e-i);if(0==h.value){a.running+=1;var u=c.value;h.value=u,h.item=c.item,c.item=null,c.value=0,e--,egret.Tween.get(h.item).to({x:h.disX,y:h.disY},l).call(function(){t.running-=1,t.running<=0&&t.addNewGrids(1)},a)}else if(h.value==c.value){a.running+=1,a.contentCon.getChildIndex(c.item)<a.contentCon.getChildIndex(h.item)&&a.contentCon.swapChildren(c.item,h.item);var d=c.item,m=h.item,v=2*c.value;c.value=0,c.item=null,h.value=v,egret.Tween.get(d).to({x:h.disX,y:h.disY},l).to({scaleX:1.2,scaleY:1.2},50).to({scaleX:.8,scaleY:.8},50).to({scaleX:1,scaleY:1},50).call(function(e,i){if(t.running-=1,e.setData(Util.numStyle[v]),t.removeFromParent(d),v>=2048){var r=Util.createLable("恭喜达到"+v+"!",0,500,40,640,16088159,"center");t.addChild(r),egret.Tween.get(r).to({y:400},1200).call(function(){t.removeFromParent(r)},t)}t.record+=v,t._grade+=v;var n=t._grade,s=t._best;if(n>s&&(t.bestRecord+=v,n=s),t.running<=0){t.addNewGrids(1);var o=t.record;t.record=0;var a=Util.createLable("+"+o,360,100,30,120,8156010,"center");if(t.addChild(a),egret.Tween.get(a).to({y:50},300).to({alpha:0},200).call(function(e){t.scoreTxt.text=""+t._grade,t.removeFromParent(e)},t,[a]),t._grade>t._best){t._best=t._grade;var h=t.bestRecord;t.bestRecord=0;var c=Util.createLable("+"+h,490,100,30,120,16094563,"center");t.addChild(c),egret.Tween.get(c).to({y:50},300).to({alpha:0},200).call(function(e){t.bestTxt.text=""+t._best,t.removeFromParent(e)},t,[a])}}},a,[m,d])}}s=e},a=this,h=0;h<r[n].length;h++)o(h),h=s},t.prototype.isOver=function(){var e=this;if(this.usefulCell().length>0)return!1;for(var t=0;t<this.items.length;t++)for(var i=1;i<this.items[t].length;i++)if(this.items[t][i].value==this.items[t][i-1].value)return!1;for(var i=0;i<this.items.length;i++)for(var t=1;t<this.items[i].length;t++)if(this.items[t][i].value==this.items[t-1][i].value)return!1;return this.gameOver.scaleX=this.gameOver.scaleY=0,this.gameOver.visible=!0,egret.Tween.get(this.gameOver).to({scaleX:1,scaleY:1},300).call(function(){e.gradeTxt.text=""+e._grade},this),!0},t.prototype.removeFromParent=function(e){e&&null!=e.parent&&e.parent.removeChild(e)},t.prototype.removeFromStage=function(){this.contentCon.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onclick,this),this.newBtn.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onclick,this),this.newGame.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onclick,this)},t}(eui.Component);__reflect(Game2048.prototype,"Game2048");var GridItemData=function(){function e(){this.value=0}return Object.defineProperty(e.prototype,"disX",{get:function(){var e=62,t=20+145*this.j+e;return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"disY",{get:function(){var e=62,t=20+145*this.i+e;return t},enumerable:!0,configurable:!0}),e}();__reflect(GridItemData.prototype,"GridItemData");var GridItem=function(e){function t(){var t=e.call(this)||this;return t.skinName="GameGridItem",t.touchEnabled=!1,t.anchorOffsetX=t.width>>1,t.anchorOffsetY=t.height>>1,t}return __extends(t,e),t.prototype.setData=function(e){this.data=e,this.grid.fillColor=e.bg,e.num>0?(this.numTxt.visible=!0,this.numTxt.text=e.num+"",this.numTxt.size=e.size,this.numTxt.textColor=e.color):this.numTxt.visible=!1},Object.defineProperty(t.prototype,"num",{get:function(){return this.data.num},enumerable:!0,configurable:!0}),t}(eui.Component);__reflect(GridItem.prototype,"GridItem");var Util=function(){function e(){}return e.createRect=function(e,t,i,r,n,s){void 0===s&&(s=1);var o=new eui.Rect(i,i,n);return o.x=e,o.y=t,o.alpha=s,o.ellipseWidth=r,o.ellipseHeight=r,o},e.createLable=function(e,t,i,r,n,s,o){var a=new eui.Label;return a.text=""+e,a.x=t,a.y=i,a.width=n,a.bold=!0,a.size=r,a.textColor=s,a.textAlign=o,a},e.numStyle={0:{num:0,color:8156010,bg:13484468,size:65},2:{num:2,color:8156010,bg:15656154,size:65},4:{num:4,color:8156010,bg:15589576,size:65},8:{num:8,color:16775147,bg:15905145,size:65},16:{num:16,color:16775147,bg:16094563,size:62},32:{num:32,color:16775147,bg:16088159,size:62},64:{num:64,color:16775147,bg:16145723,size:62},128:{num:128,color:16775147,bg:15584881,size:60},256:{num:256,color:16775147,bg:15584353,size:60},512:{num:512,color:16775147,bg:15517776,size:60},1024:{num:1024,color:16775147,bg:15582527,size:50},2048:{num:2048,color:16775147,bg:15647278,size:50},4096:{num:4096,color:16775147,bg:4012595,size:50},8192:{num:8192,color:16775147,bg:789258,size:50},16384:{num:16384,color:16775147,bg:1031356,size:40}},e}();__reflect(Util.prototype,"Util");